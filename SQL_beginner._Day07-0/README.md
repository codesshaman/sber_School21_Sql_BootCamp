# Day 07 - Piscine SQL

## _Aggregated data is more informative, isn't it?_

Resume: Today you will see how to use specific OLAP constructions to get a “Value” from data

## Contents

1. [Глава I](#chapter-i) \
    1.1. [Преамбула](#preamble)
2. [Глава II](#chapter-ii) \
    2.1. [Основные правила](#general-rules)
3. [Глава III](#chapter-iii) \
    3.1. [Правила дня](#rules-of-the-day)  
4. [Глава IV](#chapter-iv) \
    4.1. [Упражнение 00 - Простая агрегированная информация](#exercise-00-simple-aggregated-information)  
5. [Глава V](#chapter-v) \
    5.1. [Упражнение 01 - Давайте посмотрим на настоящие имена](#exercise-01-lets-see-real-names)  
6. [Глава VI](#chapter-vi) \
    6.1. [Упражнение 02 - Статистика ресторанов](#exercise-02-restaurants-statistics)  
7. [Глава VII](#chapter-vii) \
    7.1. [Упражнение 03 - Статистика ресторанов #2](#exercise-03-restaurants-statistics-2)  
8. [Глава VIII](#chapter-viii) \
    8.1. [Упражнение 04 - Предложение для групп](#exercise-04-clause-for-groups)
9. [Глава IX](#chapter-ix) \
    9.1. [Упражнение 05 - Уникальность человека](#exercise-05-persons-uniqueness)
10. [Глава X](#chapter-x) \
    10.1. [Упражнение 06 - Показатели ресторана](#exercise-06-restaurant-metrics)
11. [Глава XI](#chapter-xi) \
    11.1. [Упражнение 07 - Средний глобальный рейтинг](#exercise-07-average-global-rating)
12. [Глава XII](#chapter-xii) \
    12.1. [Упражнение 08 - Найдите расположение ресторанов пиццерии](#exercise-08-find-pizzerias-restaurant-locations)    
13. [Глава XIII](#chapter-xiii) \
    13.1. [Упражнение 09 - Явное преобразование типов](#exercise-09-explicit-type-transformation)        

## Глава I
## Преамбула

![D07_01](misc/images/D07_01.png)

Пожалуйста, взгляните на кривую полезности для получения подробных данных во времени. Другими словами, подробные данные (имеются в виду транзакции пользователей, факты о продуктах и ​​провайдерах и т. д.) бесполезны для нас с исторической точки зрения, потому что нам просто нужно знать некоторую агрегацию, чтобы описать, что происходило год назад.

Почему это происходит? Причина в нашем аналитическом уме. На самом деле мы хотим сосредоточиться на нашей бизнес-стратегии с исторической точки зрения, чтобы установить новые бизнес-цели, и нам не нужны подробности.

С точки зрения базы данных «Аналитический ум» соответствует OLAP-трафику (информационный слой), «детали» — OLTP-трафику (сырой слой данных). Сегодня существует более гибкий шаблон для хранения подробных данных и агрегированной информации в экосистеме. я говорю о `LakeHouse = DataLake + DataWareHouse`.

Если мы говорим об исторических данных, то следует упомянуть паттерн «Управление жизненным циклом данных». Простыми словами, что нам делать со старыми данными? TTL (время жизни), SLA для данных, политика хранения данных и т. д. — это термины, которые используются в стратегии управления данными. 

![D07_02](misc/images/D07_02.png)

## Глава II
## Основные правила

- Используйте эту страницу как единственную инструкцию. Не слушайте никаких слухов и домыслов о том, как подготовить своё решение.
- Пожалуйста, убедитесь, что вы используете последнюю версию PostgreSQL.
- Это совершенно нормально, если вы используете IDE для написания исходного кода (он же SQL-скрипт).
- Для оценки ваше решение должно находиться в вашем репозитории GIT.
- Ваши решения будут оценены вашими товарищами по интенсиву.
- Вы не должны оставлять в своем каталоге никаких других файлов, кроме тех, которые явно указаны в инструкциях к упражнению. Рекомендуется изменить ваш .gitignoreчтобы избежать случайностей.
- У вас есть вопрос? Спросите у соседа справа. Если не помогло - попробуйте с соседом слева.
- Ваш справочник: товарищи/интернет/гугл.
- Внимательно прочитайте примеры. Они могут понять вещи, которые иначе не указаны в задании. 
- И да прибудет с вами сила SQL!
- Абсолютно все можно представить в SQL! Давайте начнем и получайте удовольствие!

## Глава III
## Правила дня

- Убедитесь, что у вас есть собственная база данных и доступ к ней в вашем кластере PostgreSQL.
- Загрузите скрипт (materials/model.sql) с моделью базы данных здесь и примените его к своей базе данных (вы можете использовать командную строку с psql или просто запустить его через любую IDE, например DataGrip от JetBrains или pgAdmin от сообщества PostgreSQL).
- **Наш способ получения знаний является постепенным и линейным, поэтому, пожалуйста, имейте в виду, что все изменения, которые вы внесли в День03 во время упражнений 07-13 и в День04 во время Упражнение 07, должны быть на месте (это похоже на реальный мир, когда мы применили релиз и должны быть согласованы с данными для новых изменений).**
- Все задачи содержат список разрешенных и запрещенных разделов с перечисленными параметрами базы данных, типами баз данных, конструкциями SQL и т. д. Пожалуйста, ознакомьтесь с разделом перед началом.
- Пожалуйста, взгляните на логическое представление нашей модели базы данных.

![schema](misc/images/schema.png)

1. Таблица **pizzeria** (Таблица-словарь с доступными пиццериями)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - название пиццерии
- поле ``rating`` - средний рейтинг пиццерии (от 0 до 5 баллов)
2. Таблица **person** (Таблица-словарь с людьми, которые любят пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - имя человека
- поле ``age`` - возраст человека
- поле ``gender`` - пол человека
- поле ``address`` - адрес человека
3. Таблица **menu** (Таблица-словарь с доступным меню и ценой на конкретную пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``pizza_name`` - название пиццы в пиццерии
- поле ``price`` - цена конкретной пиццы
4. Таблица **person_visits** (Операционная таблица с информацией о посещениях пиццерии)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``visit_date`` - дата (например 2022-01-01) посещения пиццерии человеком
5. Таблица **person_order** (операционная таблица с информацией о заказах людей)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``menu_id`` - внешний ключ к меню
- поле ``order_date`` - дата (например 2022-01-01) заказа человека

Посещение (visit_date) и заказ (order_date) - это разные сущности, и нет никакой корреляции между их данными. Например, клиент может находиться в одном месте (просто просматривая меню) и в это время сделать заказ в другом по телефону или с помощью мобильного приложения. Или позвонить из дома с заказом без каких-либо визитов.

## Глава IV
## Упражнение 00 - Простая агрегированная информация

| Упражнение 00: Простая агрегированная информация |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex00                                                                                                                     |
| Файлы для сдачи                      | `day07_ex00.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL|

Давайте сделаем простую агрегацию, пожалуйста, напишите оператор SQL, который возвращает идентификаторы людей и соответствующее количество посещений в любых пиццериях и сортирует по количеству посещений в режиме убывания. Пожалуйста, взгляните на образец данных ниже.

| person_id | count_of_visits |
| ------ | ------ |
| 9 | 4 |
| 4 | 3 |
| ... | ... | 


## Глава V
## Упражнение 01 - Давайте посмотрим на настоящие имена

| Упражнение 01: Давайте посмотрим на настоящие имена|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex01                                                                                                                     |
| Файлы для сдачи                      | `day07_ex01.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Измените оператор SQL из упражнения 00 и верните имя человека (не идентификатор). Дополнительным пунктом является то, что нам нужно видеть только топ-5 человек с максимальным количеством посещений в любых пиццериях. Пожалуйста, взгляните на пример выходных данных ниже. 

| name | count_of_visits |
| ------ | ------ |
| Dmitriy | 4 |
| Denis | 3 |
| ... | ... | 

## Глава VI
## Упражнение 02 - Статистика ресторанов

| Упражнение 02: Статистика ресторанов|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex02                                                                                                                     |
| Файлы для сдачи                      | `day07_ex02.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, напишите оператор SQL, чтобы увидеть 3 любимых ресторана по посещениям и по заказам в одном списке (пожалуйста, добавьте столбец action_type со значениями «заказ» или «посещение», это зависит от данных из соответствующей таблицы). Пожалуйста, взгляните на образец данных ниже. Результат должен быть отсортирован по столбцу action_type в возрастающем режиме и по столбцу count в нисходящем режиме. 

| name | count | action_type |
| ------ | ------ | ------ |
| Dominos | 6 | order |
| ... | ... | ... |
| Dominos | 7 | visit |
| ... | ... | ... |

## Глава VII
## Упражнение 03 - Статистика ресторанов #2

| Упражнение 03: Статистика ресторанов #2 |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex03                                                                                                                     |
| Файлы для сдачи                      | `day07_ex03.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, напишите SQL-запрос, чтобы увидеть, что рестораны группируются по посещениям и заказам и соединяются друг с другом с помощью ограниченного имени.
Вы можете использовать внутренний Sql из Упражнение 02 (рестораны по посещениям и по заказам) без ограничений по количеству строк.

Кроме того, пожалуйста, добавьте следующие правила.
- рассчитайте сумму заказов и посещений для соответствующей пиццерии (имейте в виду, что не все ключи от пиццерии представлены в обеих таблицах).
- сортировка результатов по столбцу "total_count" в режиме убывания и по "name" в режиме возрастания.
Взгляните на приведенный ниже образец данных.

| name | total_count |
| ------ | ------ |
| Dominos | 13 |
| DinoPizza | 9 |
| ... | ... | 


## Глава VIII
## Упражнение 04 - Предложение для групп


| Упражнение 04: Предложение для групп |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex04                                                                                                                     |
| Файлы для сдачи                      | `day07_ex04.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Syntax construction                        | `WHERE`                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает имя человека и соответствующее количество посещений в любой пиццерии, если человек посетил более 3 раз (> 3). Пожалуйста, взгляните на образец данных ниже. 

| name | count_of_visits |
| ------ | ------ |
| Dmitriy | 4 |

## Глава IX
## Упражнение 05 - Уникальность человека


| Упражнение 05: Уникальность человека|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex05                                                                                                                     |
| Файлы для сдачи                      | `day07_ex05.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        |  ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Синтаксические конструкции                     |  `GROUP BY`, и тип (`UNION`,...) работающие вместе                                                                                              |

Пожалуйста, напишите простой SQL-запрос, который возвращает список уникальных имен людей, которые делали заказы в любых пиццериях. Результат должен быть отсортирован по имени человека. Пожалуйста, взгляните на образец ниже. 

| name | 
| ------ |
| Andrey |
| Anna | 
| ... | 

## Глава X
## Упражнение 06 - Показатели ресторана


| Упражнение 06: Показатели ресторана|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex06                                                                                                                     |
| Файлы для сдачи                      | `day07_ex06.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает количество заказов, среднюю цену, максимальную и минимальную цены на пиццу, проданную соответствующим рестораном-пиццерией. Результат должен быть отсортирован по названию пиццерии. Пожалуйста, взгляните на образец данных ниже. Округлите среднюю цену до 2 плавающих чисел.

| name | count_of_orders | average_price | max_price | min_price |
| ------ | ------ | ------ | ------ | ------ |
| Best Pizza | 5 | 780 | 850 | 700 |
| DinoPizza | 5 | 880 | 1000 | 800 |
| ... | ... | ... | ... | ... |


## Глава XI
## Упражнение 07 - Средний глобальный рейтинг


| Упражнение 07: Средний глобальный рейтинг|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex07                                                                                                                     |
| Файлы для сдачи                      | `day07_ex07.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Напишите оператор SQL, который возвращает общий средний рейтинг (имя выходного атрибута — global_rating) для всех ресторанов. Округлите средний рейтинг до 4 плавающих чисел.

## Глава XII
## Упражнение 08 - Найдите расположение ресторанов пиццерии


| Упражнение 08: Найдите расположение ресторанов пиццерии|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex08                                                                                                                     |
| Файлы для сдачи                      | `day07_ex08.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Мы знаем о личных адресах из наших данных. Представим, что этот конкретный человек посещает пиццерии только в своем городе. Пожалуйста, напишите оператор SQL, который возвращает адрес, название пиццерии и количество заказов. Результат должен быть отсортирован по адресу, а затем по названию ресторана. Пожалуйста, взгляните на образец выходных данных ниже.

| address | name |count_of_orders |
| ------ | ------ |------ |
| Kazan | Best Pizza |4 |
| Kazan | DinoPizza |4 |
| ... | ... | ... | 

## Глава XIII
## Упражнение 09 - Явное преобразование типов

| Упражнение 09: Явное преобразование типов|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex09                                                                                                                     |
| Файлы для сдачи                      | `day07_ex09.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает агрегированную информацию по адресу человека, среднему возрасту по адресу, результату «(Максимальный возраст - Минимальный возраст) / Максимальный возраст», который представлен в виде столбца формулы и результат сравнения между формулой и средним столбцом (другими словами, если формула больше среднего, то значение True, в противном случае значение False).

Результат должен быть отсортирован по столбцу адреса. Пожалуйста, взгляните на образец выходных данных ниже.

| address | formula |average | comparison |
| ------ | ------ |------ |------ |
| Kazan | 44.71 |30.33 | true |
| Moscow | 20.24 | 18.5 | true |
| ... | ... | ... | ... |
