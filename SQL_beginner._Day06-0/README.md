# Day 06 - Piscine SQL

## _Let's improve customer experience_

Resume: Today you will see how to add a new business feature into our data model

## Contents

1. [Глава I](#chapter-i) \
    1.1. [Преамбула](#preamble)
2. [Глава II](#chapter-ii) \
    2.1. [Основные правила](#general-rules)
3. [Глава III](#chapter-iii) \
    3.1. [Правила дня](#rules-of-the-day)  
4. [Глава IV](#chapter-iv) \
    4.1. [Упражнение 00 - Скидки, скидки, все любят скидки](#exercise-00-discounts-discounts-everyone-loves-discounts)  
5. [Глава V](#chapter-v) \
    5.1. [Упражнение 01 - Установим персональные скидки](#exercise-01-lets-set-personal-discounts)  
6. [Глава VI](#chapter-vi) \
    6.1. [Упражнение 02 - Пересчитаем историю заказов.](#exercise-02-lets-recalculate-a-history-of-orders)  
7. [Глава VII](#chapter-vii) \
    7.1. [Упражнение 03 - Возможны улучшения](#exercise-03-improvements-are-in-a-way)  
8. [Глава VIII](#chapter-viii) \
    8.1. [Упражнение 04 - Нам нужно больше согласованности данных](#exercise-04-we-need-more-data-consistency)
9. [Глава IX](#chapter-ix) \
    9.1. [Упражнение 05 - Правила управления данными](#exercise-05-data-governance-rules)
10. [Глава X](#chapter-x) \
    10.1. [Упражнение 06 - Автоматизируем генерацию первичного ключа](#exercise-06-lets-automate-primary-key-generation)

## Глава I
## Преамбула

![D06_01](misc/images/D06_01.png)

Почему алмаз является одним из самых прочных предметов? Причина в конструкции. Каждый атом знает о своем месте в топологии алмаза и делает весь алмаз нерушимым.

Логическая структура подобна бриллианту. Если вы найдете подходящую структуру для своей собственной модели базы данных, вы найдете золото (или алмаз :-). Есть два аспекта моделирования баз данных. Первый — это логическое представление, другими словами, как ваша модель будет плавно описывать реальный деловой мир.

![D06_02](misc/images/D06_02.png)

С другой стороны, ваша модель должна решать ваши функциональные задачи с минимальным воздействием. Это означает, что представление логической модели преобразуется в представление физической модели, а не только из описаний таблиц и атрибутов. Но на самом деле, с точки зрения производительности и бюджета, которые в настоящее время более важны. Как найти баланс? Для этого случая есть 3 шага, чтобы создать очень хороший дизайн. Просто взгляните на картинку ниже.

![D06_03](misc/images/D06_03.png)


## Глава II
## Основные правила

- Используйте эту страницу как единственную инструкцию. Не слушайте никаких слухов и домыслов о том, как подготовить своё решение.
- Пожалуйста, убедитесь, что вы используете последнюю версию PostgreSQL.
- Это совершенно нормально, если вы используете IDE для написания исходного кода (он же SQL-скрипт).
- Для оценки ваше решение должно находиться в вашем репозитории GIT.
- Ваши решения будут оценены вашими товарищами по интенсиву.
- Вы не должны оставлять в своем каталоге никаких других файлов, кроме тех, которые явно указаны в инструкциях к упражнению. Рекомендуется изменить ваш .gitignoreчтобы избежать случайностей.
- У вас есть вопрос? Спросите у соседа справа. Если не помогло - попробуйте с соседом слева.
- Ваш справочник: товарищи/интернет/гугл.
- Внимательно прочитайте примеры. Они могут понять вещи, которые иначе не указаны в задании. 
- И да прибудет с вами сила SQL!
- Абсолютно все можно представить в SQL! Давайте начнем и получайте удовольствие!

## Глава III
## Правила дня

- Убедитесь, что у вас есть собственная база данных и доступ к ней в вашем кластере PostgreSQL.
- Загрузите скрипт (materials/model.sql) с моделью базы данных здесь и примените его к своей базе данных (вы можете использовать командную строку с psql или просто запустить его через любую IDE, например DataGrip от JetBrains или pgAdmin от сообщества PostgreSQL).
- Все задачи содержат список разрешенных и запрещенных разделов с перечисленными параметрами базы данных, типами баз данных, конструкциями SQL и т. д. Пожалуйста, ознакомьтесь с разделом перед началом.
- Пожалуйста, взгляните на логическое представление нашей модели базы данных.

![schema](misc/images/schema.png)

1. Таблица **pizzeria** (Таблица-словарь с доступными пиццериями)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - название пиццерии
- поле ``rating`` - средний рейтинг пиццерии (от 0 до 5 баллов)
2. Таблица **person** (Таблица-словарь с людьми, которые любят пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - имя человека
- поле ``age`` - возраст человека
- поле ``gender`` - пол человека
- поле ``address`` - адрес человека
3. Таблица **menu** (Таблица-словарь с доступным меню и ценой на конкретную пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``pizza_name`` - название пиццы в пиццерии
- поле ``price`` - цена конкретной пиццы
4. Таблица **person_visits** (Операционная таблица с информацией о посещениях пиццерии)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``visit_date`` - дата (например 2022-01-01) посещения пиццерии человеком
5. Таблица **person_order** (операционная таблица с информацией о заказах людей)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``menu_id`` - внешний ключ к меню
- поле ``order_date`` - дата (например 2022-01-01) заказа человека

Посещение (visit_date) и заказ (order_date) - это разные сущности, и нет никакой корреляции между их данными. Например, клиент может находиться в одном месте (просто просматривая меню) и в это время сделать заказ в другом по телефону или с помощью мобильного приложения. Или позвонить из дома с заказом без каких-либо визитов.

## Глава IV
## Упражнение 00 - Скидки, скидки, все любят скидки 

| Упражнение 00: Скидки, скидки, все любят скидки  |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex00                                                                                                                     |
| Файлы для сдачи                      | `day06_ex00.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |

Давайте расширим нашу модель данных, включив в нее новую бизнес-функцию. Каждый человек хочет видеть персональную скидку и каждый бизнес хочет быть ближе к клиентам.

Пожалуйста, подумайте о персональных скидках для людей с одной стороны и ресторанов-пиццерий с другой. Необходимо создать новую реляционную таблицу (пожалуйста, задайте имя `person_discounts`) со следующими правилами:
- установите атрибут id как первичный ключ (пожалуйста, посмотрите на столбец id в существующих таблицах и выберите тот же тип данных)
- установить внешние ключи атрибутов person_id и pizzeria_id для соответствующих таблиц (типы данных должны быть такими же, как и для столбцов id в соответствующих родительских таблицах)
- пожалуйста, установите явные имена для ограничений внешних ключей по шаблону fk_{table_name}_{column_name}, например `fk_person_discounts_person_id`
- добавьте атрибут скидки для хранения значения скидки в процентах. Помните, что значение скидки может быть числом с плавающей запятой. Поэтому, пожалуйста, выберите соответствующий тип данных, чтобы покрыть эту возможность.

## Глава V
## Упражнение 01 - Установим персональные скидки

| Упражнение 01: Установим персональные скидки|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex01                                                                                                                     |
| Файлы для сдачи                      | `day06_ex01.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |

Собственно, мы создали структуру для хранения наших скидок и готовы идти дальше и наполнять нашу таблицу `person_discounts` с новыми записями.

Итак, есть таблица `person_order` который хранит историю заказов человека. Пожалуйста, напишите оператор DML (`INSERT INTO ... SELECT ...`), который вставляет новые записи в таблицу `person_discounts` на основе следующих правил:
- взять агрегированное состояние по столбцам person_id и pizzeria_id

- рассчитать величину персональной скидки по следующему псевдокоду:

```
    `if “amount of orders” = 1 then
        “discount” = 10.5 
    else if “amount of orders” = 2 then 
        “discount” = 22
    else 
        “discount” = 30`
```

- чтобы сгенерировать первичный ключ для таблицы person_discounts, используйте приведенную ниже конструкцию SQL (эта конструкция взята из области SQL WINDOW FUNCTION).

    `... ROW_NUMBER( ) OVER ( ) AS id ...`

## Глава VI
## Упражнение 02 - Пересчитаем историю заказов

| Упражнение 02: Пересчитаем историю заказов|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex02                                                                                                                     |
| Файлы для сдачи                      | `day06_ex02.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает заказы с фактической ценой и ценой с примененной скидкой для каждого человека в соответствующем ресторане-пиццерии и сортирует по имени человека и названию пиццы. Пожалуйста, взгляните на образец данных ниже.

| name | pizza_name | price | discount_price | pizzeria_name | 
| ------ | ------ | ------ | ------ | ------ |
| Andrey | cheese pizza | 800 | 624 | Dominos |
| Andrey | mushroom pizza | 1100 | 858 | Dominos |
| ... | ... | ... | ... | ... |

## Глава VII
## Упражнение 03 - Возможны улучшения

| Упражнение 03: Возможны улучшения |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex03                                                                                                                     |
| Файлы для сдачи                      | `day06_ex03.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |

На самом деле нам нужно улучшить согласованность данных с одной стороны и настроить производительность с другой стороны. Пожалуйста, создайте многоколоночный уникальный индекс (с именем `idx_person_discounts_unique`), который предотвращает дублирование парных значений идентификаторов человека и пиццерии.

После создания нового индекса предоставьте любую простую инструкцию SQL, которая показывает доказательство использования индекса (с помощью`EXPLAIN ANALYZE`). Пример «доказательства» ниже
    
```
Index Scan using idx_person_discounts_unique on person_discounts
```

## Глава VIII
## Упражнение 04 - Нам нужно больше согласованности данных


| Упражнение 04: Нам нужно больше согласованности данных |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex04                                                                                                                     |
| Файлы для сдачи                      | `day06_ex04.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |

Пожалуйста, добавьте следующие правила ограничения для существующих атрибутов таблицы `person_discounts`.
- столбец person_id не должен быть NULL (используйте имя ограничения `ch_nn_person_id`)
- столбец pizzeria_id не должен быть NULL (используйте имя ограничения `ch_nn_pizzeria_id`)
- столбец скидки не должен быть NULL (используйте имя ограничения `ch_nn_discount`)
- столбец скидки должен быть 0 процентов по умолчанию
- столбец скидки должен находиться в диапазоне значений от 0 до 100 (используйте имя ограничения `ch_range_discount`)

## Глава IX
## Упражнение 05 - Правила управления данными

| Упражнение 05: Правила управления данными|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex05                                                                                                                     |
| Файлы для сдачи                      | `day06_ex05.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        |  SQL, DML, DDL                                                                                              |

Чтобы соответствовать политикам управления данными, необходимо добавить комментарии к таблице и каждому атрибуту внутри. Применим эту политику к таблице `person_discounts` table. Пожалуйста, добавьте комментарии на английском или русском языке (на ваше усмотрение), поясняющие, какова бизнес-цель таблицы и атрибутов.

## Глава X
## Упражнение 06 - Автоматизируем генерацию первичного ключа


| Упражнение 06: Автоматизируем генерацию первичного ключа|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex06                                                                                                                     |
| Файлы для сдачи                      | `day06_ex06.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | SQL, DML, DDL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Шаблон синтаксиса SQL                        | Не используйте жестко закодированное значение для количества строк, чтобы установить правильное значение для последовательности.                                                                                             |

Давайте создадим последовательность базы данных с именем `seq_person_discounts`(начиная с 1 значения) и установите значение по умолчанию для атрибута id таблицы `person_discounts`, из которой нужно взять значение `seq_person_discounts` каждый раз автоматически. Имейте в виду, что ваш следующий порядковый номер равен 1, в этом случае установите фактическое значение для последовательности базы данных на основе формулы «количество строк в таблице person_discounts» + 1. В противном случае вы получите ошибки об ограничении нарушения первичного ключа. 
