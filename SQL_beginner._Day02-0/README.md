# Day 02 - Piscine SQL

## _Deep diving into JOINs in SQL_

Resume: Today you will see how to get needed data based on different structures JOINs

## Contents

1. [Глава I](#chapter-i) \
    1.1. [Преамбула](#preamble)
2. [Глава II](#chapter-ii) \
    2.1. [Основные правила](#general-rules)
3. [Глава III](#chapter-iii) \
    3.1. [Правила дня](#rules-of-the-day)  
4. [Глава IV](#chapter-iv) \
    4.1. [Упражнение 00 - Двигайтесь ВЛЕВО, двигайтесь ВПРАВО](#exercise-00-move-to-the-left-move-to-the-right)  
5. [Глава V](#chapter-v) \
    5.1. [Упражнение 01 - Найдите пробелы в данных](#exercise-01-find-data-gaps)  
6. [Глава VI](#chapter-vi) \
    6.1. [Упражнение 02 - ПОЛНЫЙ означает «полностью заполненный»](#exercise-02-full-means-completely-filled)  
7. [Глава VII](#chapter-vii) \
    7.1. [Упражнение 03 - Преобразование в CTE](#exercise-03-reformat-to-cte)  
8. [Глава VIII](#chapter-viii) \
    8.1. [Упражнение 04 - Найдите любимую пиццу](#exercise-04-find-a-favorite-pizzas)
9. [Глава IX](#chapter-ix) \
    9.1. [Упражнение 05 - Исследование личных данных](#exercise-05-investigate-person-data)
10. [Глава X](#chapter-x) \
    10.1. [Упражнение 06 - Любимые пиццы Дениса и Анны](#exercise-06-favorite-pizzas-for-denis-and-anna)
11. [Глава XI](#chapter-xi) \
    11.1. [Упражнение 07 - Самая дешевая пиццерия для Дмитрия](#exercise-07-cheapest-pizzeria-for-dmitriy)
12. [Глава XII](#chapter-xii) \
    12.1. [Упражнение 08 - Продолжаем исследовать данные](#exercise-08-continuing-to-research-data)
13. [Глава XIII](#chapter-xiii) \
    13.1. [Упражнение 09 - Кто любит сыр и пепперони?](#exercise-09-who-loves-cheese-and-pepperoni)
14. [Глава XIV](#chapter-xiv) \
    14.1. [Упражнение 10 - Найдите людей из одного города](#exercise-10-find-persons-from-one-city)


## Глава I
## Преамбула

![D02_01](misc/images/D02_01.png)

На рисунке вы можете увидеть реляционное выражение в древовидном представлении. Это выражение соответствует следующему SQL-запросу:

```
    SELECT *
        FROM R CROSS JOIN S
    WHERE clause
```

Итак, другими словами, мы можем описать любой SQL в математических терминах реляционной алгебры.

Главный вопрос (который я слышу от своих студентов): зачем нам изучать реляционную алгебру в курсе, если мы можем написать SQL с первого раза? Мой ответ и да и нет. «Да» означает, что вы можете написать SQL с первой попытки, это верно, «Нет» означает, что вы должны знать основные аспекты реляционной алгебры, потому что она используется для планов оптимизации и для семантических запросов. Какие типы соединений представлены в реляционной алгебре? На самом деле «Cross Join» — это примитивный оператор, который является родителем для других типов соединений. 

- Natural Join
- Theta Join
- Semi Join
- Anti Join
- Left / Right / Full Joins

Но что такое операция соединения между двумя таблицами? Позвольте мне представить часть псевдокода, как работает операция объединения без индексации.

```
    FOR r in R LOOP
        FOR s in S LOOP
        if r.id = s.r_id then add(r,s)
        …
        END;
    END;
```

Это просто набор циклов... Совсем не магия 

## Глава II
## Основные правила

- Используйте эту страницу как единственную инструкцию. Не слушайте никаких слухов и домыслов о том, как подготовить своё решение.
- Пожалуйста, убедитесь, что вы используете последнюю версию PostgreSQL.
- Это совершенно нормально, если вы используете IDE для написания исходного кода (он же SQL-скрипт).
- Для оценки ваше решение должно находиться в вашем репозитории GIT.
- Ваши решения будут оценены вашими товарищами по интенсиву.
- Вы не должны оставлять в своем каталоге никаких других файлов, кроме тех, которые явно указаны в инструкциях к упражнению. Рекомендуется изменить ваш .gitignoreчтобы избежать случайностей.
- У вас есть вопрос? Спросите у соседа справа. Если не помогло - попробуйте с соседом слева.
- Ваш справочник: товарищи/интернет/гугл.
- Внимательно прочитайте примеры. Они могут понять вещи, которые иначе не указаны в задании. 
- И да прибудет с вами сила SQL!
- Абсолютно все можно представить в SQL! Давайте начнем и получайте удовольствие!

## Глава III
## Правила дня

- Убедитесь, что у вас есть собственная база данных и доступ к ней в вашем кластере PostgreSQL.
- Загрузите скрипт (materials/model.sql) с моделью базы данных здесь и примените его к своей базе данных (вы можете использовать командную строку с psql или просто запустить его через любую IDE, например DataGrip от JetBrains или pgAdmin от сообщества PostgreSQL).
- Все задачи содержат список разрешенных и запрещенных разделов с перечисленными параметрами базы данных, типами баз данных, конструкциями SQL и т. д. Пожалуйста, ознакомьтесь с разделом перед началом.
- Пожалуйста, взгляните на логическое представление нашей модели базы данных.

![schema](misc/images/schema.png)

1. Таблица **pizzeria** (Таблица-словарь с доступными пиццериями)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - название пиццерии
- поле ``rating`` - средний рейтинг пиццерии (от 0 до 5 баллов)
2. Таблица **person** (Таблица-словарь с людьми, которые любят пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``name`` - имя человека
- поле ``age`` - возраст человека
- поле ``gender`` - пол человека
- поле ``address`` - адрес человека
3. Таблица **menu** (Таблица-словарь с доступным меню и ценой на конкретную пиццу)
- поле ``id`` - первичный ключ (primary key)
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``pizza_name`` - название пиццы в пиццерии
- поле ``price`` - цена конкретной пиццы
4. Таблица **person_visits** (Операционная таблица с информацией о посещениях пиццерии)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``pizzeria_id`` - внешний ключ к пиццерии
- поле ``visit_date`` - дата (например 2022-01-01) посещения пиццерии человеком
5. Таблица **person_order** (операционная таблица с информацией о заказах людей)
- поле ``id`` - первичный ключ (primary key)
- поле ``person_id`` - внешний ключ к человеку
- поле ``menu_id`` - внешний ключ к меню
- поле ``order_date`` - дата (например 2022-01-01) заказа человека

Посещение (visit_date) и заказ (order_date) - это разные сущности, и нет никакой корреляции между их данными. Например, клиент может находиться в одном месте (просто просматривая меню) и в это время сделать заказ в другом по телефону или с помощью мобильного приложения. Или позвонить из дома с заказом без каких-либо визитов.

## Глава IV
## Упражнение 00 - Двигайтесь ВЛЕВО, двигайтесь ВПРАВО

| Упражнение 00: Двигайтесь ВЛЕВО, двигайтесь ВПРАВО |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex00                                                                                                                     |
| Файлы для сдачи                      | `day02_ex00.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Синтаксические конструкции SQL                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает список названий пиццерий, которые никто не посещал.

## Глава V
## Упражнение 01 - Найдите пробелы в данных

| Упражнение 01: Найдите пробелы в данных|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex01                                                                                                                     |
| Файлы для сдачи                      | `day02_ex01.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| Синтаксические конструкции SQL                        | `generate_series(...)`                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Синтаксические конструкции SQL                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает пропущенные дни из интервала с 1 по 10 января 2022 года для посещений лиц с идентификаторами 1 и 2. Упорядочьте по дням посещения по возрастанию. Образец данных с именем столбца представлен ниже.

| missing_date |
| ------ |
| 2022-01-03 |
| 2022-01-04 |
| 2022-01-05 |
| ... |

## Глава VI
## Упражнение 02 - ПОЛНЫЙ означает «полностью заполненный»

| Упражнение 02: ПОЛНЫЙ означает «полностью заполненный»|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex02                                                                                                                     |
| Файлы для сдачи                      | `day02_ex02.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Синтаксические конструкции SQL                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Пожалуйста, напишите оператор SQL, который возвращает полный список имен людей, посетивших (или не посетивших) пиццерии в интервале времени с 1 по 3 января 2022 года с одной стороны, и весь список имен пиццерий, которые были посещены или не посещены с другой стороны. Другая сторона. Пример данных с нужными именами столбцов представлен ниже. Обратите внимание на значение замены '-' для значений `NULL` в столбцах `person_name` и `pizzeria_name` Пожалуйста, также добавьте порядок по всем 3 столбцам.

| person_name | visit_date | pizzeria_name |
| ------ | ------ | ------ |
| - | null | DinoPizza |
| - | null | DoDo Pizza |
| Andrey | 2022-01-01 | Dominos |
| Andrey | 2022-01-02 | Pizza Hut |
| Anna | 2022-01-01 | Pizza Hut |
| Denis | null | - |
| Dmitriy | null | - |
| ... | ... | ... |

## Глава VII
## Упражнение 03 - Преобразование в CTE

| Упражнение 03: Преобразование в CTE |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex03                                                                                                                     |
| Файлы для сдачи                      | `day02_ex03.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| Синтаксические конструкции SQL                        | `generate_series(...)`                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| Синтаксические конструкции SQL                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Вернемся к упражнению № 01. Пожалуйста, перепишите свой SQL, используя шаблон CTE (Common Table Expression). Пожалуйста, перейдите в часть CTE вашего дневного генератора. Результат должен быть таким же, как в упражнении № 01.

| missing_date | 
| ------ | 
| 2022-01-03 | 
| 2022-01-04 | 
| 2022-01-05 | 
| ... |

## Глава VIII
## Упражнение 04 - Найдите любимую пиццу


| Упражнение 04: Найдите любимую пиццу |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex04                                                                                                                     |
| Файлы для сдачи                      | `day02_ex04.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите полную информацию обо всех возможных названиях пиццерий и ценах, чтобы получить пиццу с грибами или пепперони. Затем отсортируйте результат по названию пиццы и названию пиццерии. Результат выборки данных приведен ниже (пожалуйста, используйте те же имена столбцов в своем операторе SQL).

| pizza_name | pizzeria_name | price |
| ------ | ------ | ------ |
| mushroom pizza | Dominos | 1100 |
| mushroom pizza | Papa Johns | 950 |
| pepperoni pizza | Best Pizza | 800 |
| ... | ... | ... |

## Глава IX
## Упражнение 05 - Исследование личных данных


| Упражнение 05: Исследование личных данных |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex05                                                                                                                     |
| Файлы для сдачи                      | `day02_ex05.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите имена всех лиц женского пола старше 25 лет и упорядочите результат по имени. Образец вывода представлен ниже.

| name | 
| ------ | 
| Elvira | 
| ... |



## Глава X
## Упражнение 06 - Любимые пиццы Дениса и Анны


| Упражнение 06: Любимые пиццы Дениса и Анны |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex06                                                                                                                     |
| Файлы для сдачи                      | `day02_ex06.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, найдите все названия пицц (и соответствующие названия ресторанов-пиццерий используя таблицу `menu`), которые заказывали Денис и Анна, и упорядочите результат по обоим столбцам. Образец вывода представлен ниже.

| pizza_name | pizzeria_name |
| ------ | ------ |
| cheese pizza | Best Pizza |
| cheese pizza | Pizza Hut |
| ... | ... |

## Глава XI
## Упражнение 07 - Самая дешевая пиццерия для Дмитрия


| Упражнение 07: Самая дешевая пиццерия для Дмитрия |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex07                                                                                                                     |
| Файлы для сдачи                      | `day02_ex07.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Please find the name of pizzeria Dmitriy visited on January 8, 2022 and could eat pizza for less than 800 rubles.

## Глава XII
## Упражнение 08 - Продолжаем исследовать данные

| Упражнение 08: Продолжаем исследовать данные |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex08                                                                                                                     |
| Файлы для сдачи                      | `day02_ex08.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |           

Пожалуйста, найдите названия пиццерий, в которых бывал Дмитрий и где можно купить пиццу, которую он ест менее чем за 800 рублей 8 января 2022 года. 

| name | 
| ------ | 
| Dmitriy | 
| ... |

## Глава XIII
## Упражнение 09 - Кто любит сыр и пепперони?

| Упражнение 09: Кто любит сыр и пепперони? |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex09                                                                                                                     |
| Файлы для сдачи                      | `day02_ex09.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, найдите имена всех мужчин из Москвы или Самары, которые заказывают либо пепперони, либо грибную пиццу (или и то, и другое). Упорядочить результат по имени человека в порядке убывания. Образец вывода представлен ниже. 

| name | 
| ------ | 
| Anna | 
| ... |

## Глава XIV
## Упражнение 10 - Найдите людей из одного города

| Exercise 10: Найдите людей из одного города |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог сдачи                     | ex10                                                                                                                     |
| Файлы для сдачи                      | `day02_ex10.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Пожалуйста, найдите имена людей, которые живут по тому же адресу. Убедитесь, что результат упорядочен по имени 1-го лица, имени 2-го лица и общему адресу. Образец данных представлен ниже. Пожалуйста, убедитесь, что ваши имена столбцов соответствуют именам столбцов ниже. 

| person_name1 | person_name2 | common_address | 
| ------ | ------ | ------ |
| Andrey | Anna | Moscow |
| Denis | Kate | Kazan |
| Elvira | Denis | Kazan |
| ... | ... | ... |

